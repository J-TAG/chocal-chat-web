<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chocal Chat</title>
</head>
<body>
<h1>WebSocket Echo Client</h1>
<p>
    <input type="text" id="inputName"/>
    <button onClick="initWebSocket();">Connect</button>
    <button onClick="stopWebSocket();">Disconnect</button>
    <button onClick="checkSocket();">State</button>
</p>
<p>
    <textarea id="debugTextArea" style="width:400px;height:200px;"></textarea>
</p>
<p>
    <textarea id="inputText" onkeydown="if(event.keyCode==13)sendMessage();"></textarea>
    <button onClick="sendMessage();">Send</button>
</p>

<script type="text/javascript">
    var debugTextArea = document.getElementById("debugTextArea");
    var myUserKey = 0;
    function debug(message) {
        debugTextArea.value += message + "\n";
        debugTextArea.scrollTop = debugTextArea.scrollHeight;
    }

    function sendRegisterMessage() {

        if (websocket != null) {
            var myName = document.getElementById("inputName").value;
            var msg = JSON.stringify({
                type: "register", name: myName
            });
            websocket.send(msg);
            console.log("string sent :", '"' + msg + '"');
        }
    }

    function sendMessage() {
        var msg = document.getElementById("inputText").value;
        if (websocket != null) {
            document.getElementById("inputText").value = "";
            var json = {type: "plain", image: "", message: msg, user_key: myUserKey};
            websocket.send(JSON.stringify(json));
            console.log("string sent :", '"' + msg + '"');
        }
    }

    var wsUri = "ws://192.168.1.12:36911";
    var websocket = null;

    function initWebSocket() {
        try {
            if (typeof MozWebSocket == 'function')
                WebSocket = MozWebSocket;
            if (websocket && websocket.readyState == 1)
                websocket.close();
            websocket = new WebSocket(wsUri);
            websocket.onopen = function (evt) {
                debug("CONNECTED");
                sendRegisterMessage();
            };
            websocket.onclose = function (evt) {
                debug("DISCONNECTED");
            };
            websocket.onmessage = function (evt) {
                var message = JSON.parse(evt.data);
                console.log("Message received :", evt.data);
                if (message.type == "accepted") {
                    myUserKey = message.user_key;
                }
                debug(message.message);
            };
            websocket.onerror = function (evt) {
                debug('ERROR: ' + evt.data);
            };
        } catch (exception) {
            debug('ERROR: ' + exception);
        }
    }

    function stopWebSocket() {
        if (websocket)
            websocket.close();
    }

    function checkSocket() {
        if (websocket != null) {
            var stateStr;
            switch (websocket.readyState) {
                case 0:
                {
                    stateStr = "CONNECTING";
                    break;
                }
                case 1:
                {
                    stateStr = "OPEN";
                    break;
                }
                case 2:
                {
                    stateStr = "CLOSING";
                    break;
                }
                case 3:
                {
                    stateStr = "CLOSED";
                    break;
                }
                default:
                {
                    stateStr = "UNKNOW";
                    break;
                }
            }
            debug("WebSocket state = " + websocket.readyState + " ( " + stateStr + " )");
        } else {
            debug("WebSocket is null");
        }
    }
</script>
</body>
</html>
